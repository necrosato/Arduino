#include <ESP8266WiFi.h>
#include <string.h>
#include "othello.hpp"
////////////////////// // WiFi Definitions //
//////////////////////
// this esp's ap credentials
const char AP_NAME[] = "othello";
const char WiFiAPPSK[] = "othello123";
// other wifi credentials
//const char *ssid = "";
//const char *password = "";

/////////////////////
// Pin Definitions //
/////////////////////
const int LED_PIN = D4; // ESP's onboard, green LED
const int ANALOG_PIN = A0; // The only analog pin on the ESP
const int DIGITAL_PIN = D3; // Digital pin to be read


int wifiStatus;
IPAddress ip(1,1,1,1);                // this node's ap ip
IPAddress gateway(1,1,1,1);           // this node's ap default router
IPAddress subnet(255,255,255,0);      // subnet mask, this node's ap subnet addres: 1.1.1.1, broadcast: 1.1.1.255
WiFiServer server(80); 

Othello game1(8, Serial);
OthelloServer game1srv(game1);

// HTML BUFFERS
struct othello_page {
    int html_len;
    char html[8192];
    char t1[1024];
    char html_foot[1024];

};

void init_othello_page(struct othello_page *p) {
    strcpy(p->html, 
"HTTP/1.1 200 OK\r\n\
Content-Type: text/html\r\n\r\n\
<!DOCTYPE HTML>\r\n<html>\r\
<head> <title>ESP8266 Othello</title> </head>\
<body> <h1>ESP8266 Othello</h1>");

    strcpy(p->html_foot,
"</body>\n\
</html>\n");

    p->html_len = strlen(p->html);
}

void add_t1(struct othello_page *p) {
    char t1p1[] = "<table border=\"1\"> <tr><th>Black Score: </th><th>White Score: </th><th>Current Player: </th></tr>";
    const char *nb = String(game1.numBlack).c_str();
    const char *nw = String(game1.numWhite).c_str();
    char *htmlp = p->html + p->html_len;

    strcpy(htmlp, t1p1);
    htmlp += strlen(t1p1);
    strcpy(htmlp, "<tr><td>");
    htmlp += 8;
    strcpy(htmlp, nb);
    htmlp += strlen(nb);
    strcpy(htmlp, "</td><td>");
    htmlp += 9;
    strcpy(htmlp, nw);
    htmlp += strlen(nw);
    strcpy(htmlp, "</td><td>");
    htmlp += 9;
    strcpy(htmlp, (game1.current == Othello::BLACK ? "Black" : "White"));
    htmlp += 5;
    strcpy(htmlp, "</td></tr>\n</table>\n");
    htmlp += 20;
    p->html_len = strlen(p->html);
    if ((p->html + p->html_len) != htmlp) {
        Serial.println("ERROR");
        Serial.println(strlen(p->html));
        Serial.println(strlen(htmlp));
    }
}

struct othello_page page;

void setup() 
{
  initHardware();
  setupWiFi();
  server.begin();
  init_othello_page(&page);
}

void loop() 
{
  // Check if a client has connected
  WiFiClient client = server.available();
  if (!client) {
    return;
  }

  // Read the first line of the request
  String req = client.readStringUntil('\r');
  Serial.println(req);
  client.flush();

  // Match the request
  int val = -1; // We'll use 'val' to keep track of both the
                // request type (read/set) and value if set.
  int ri = -1;
  char br, bc;
  if ((ri = req.indexOf("/othello")) != -1) {
    val = 1; // Will print othello board
  } else if ((ri = req.indexOf("/maketurn")) != -1) {
    val = 2; // Will print othello board
    br = req[ri+9];
    bc = req[ri+10];
  }

  client.flush();

  init_othello_page(&page);

  if (val == 1 || val == 2) {
        add_t1(&page);
        String rows = "";
        for (int i = 0; i < 8; i++) {
            String row = "<tr>";
            for (int j = 0; j < 8; j++) {
                row += "<td><form name=\""+String(i)+String(j)+"\" action=\"/maketurn"+String(i)+String(j)+"\"><button type=submit\" style=\"background-color: ";
                if (game1.grid[i][j] == Othello::BLACK) {
                    row += "#555555;\"> b ";
                }
                else if (game1.grid[i][j] == Othello::WHITE) {
                    row += "#FFFFFF;\"> w ";
                }
                else {
                    row += "#e7e7e7;\"> _ ";
                }
                row += "</button></form></td>";
            }
            row += "</tr>\n";
            rows += row;
        }
        String t2_head = "<table border=\"1\">";
        String t2_foot = "</table>";
        String t2 = t2_head + rows + t2_foot;
  }

  // Send the response to the client
  client.print(page.html);
  delay(1);
  Serial.println("Client disonnected");

  // The client will actually be disconnected 
  // when the function returns and 'client' object is detroyed
}

void setupWiFi()
{
  Serial.print("This device's MAC address is: ");
  Serial.println(WiFi.macAddress());

  WiFi.softAPConfig(ip, gateway, subnet);
  WiFi.softAP(AP_NAME, WiFiAPPSK, 6, 0);
  Serial.print("This AP's IP address is: ");
  Serial.println(WiFi.softAPIP());  

    /*
  WiFi.begin(ssid, password);
  WiFi.config(sta_ip, sta_gateway, subnet);

  int linenum = 10, attempt = 1;
  while (WiFi.status() != WL_CONNECTED) {
      delay(500);
      if (attempt % linenum == 0) {
          Serial.println(".");
      }
      else {
          Serial.print(".");
      }
      attempt++;
  }
  wifiStatus = WiFi.status();
  if(wifiStatus == WL_CONNECTED){
      Serial.print("\nConnected - Your IP address is: ");
      Serial.println(WiFi.localIP());  
  }
    */
}
void initHardware()
{
  Serial.begin(115200);
  Serial.println("\n\n");
  pinMode(DIGITAL_PIN, INPUT_PULLUP);
  pinMode(LED_PIN, OUTPUT); 
  digitalWrite(LED_PIN, HIGH);//on Lolin ESP8266 v3 dev boards, the led is active low
  delay(1000);
  // Don't need to set ANALOG_PIN as input, 
  // that's all it can be.
}
